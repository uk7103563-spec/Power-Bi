<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security Enhancements -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.sheetjs.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';">
    <meta name="referrer" content="no-referrer">
    <title>Enterprise Strategic Intelligence Unit | Dynamic AI BI</title>

    <!-- External Assets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --glass: rgba(15, 23, 42, 0.75);
            --border: rgba(105, 50, 50, 0.1);
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f1f5f9;
            --text-muted: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar Control --- */
        aside {
            width: 330px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 16px;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 50;
        }

        .logo-box {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(56, 189, 248, 0.15);
        }

        .label {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--text-muted);
            letter-spacing: 0.15em;
            margin-bottom: 6px;
            display: block;
        }

        input,
        select {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 10px;
            color: var(--text-main);
            font-size: 0.85rem;
            outline: none;
            margin-bottom: 4px;
        }

        .btn-activate {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
            margin-top: 10px;
        }

        .btn-activate:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* --- Main Area --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.05), transparent);
        }

        .header-bar {
            padding: 24px 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(20px);
            z-index: 40;
            flex-shrink: 0;
        }

        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 32px 40px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .page-view {
            display: none;
            flex-direction: column;
            gap: 24px;
            animation: slideUp 0.3s cubic-bezier(0, 0, 0.2, 1);
        }

        .page-view.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
        }

        .kpi-h {
            font-size: 0.73rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 700;
            gap: 8px;
            display: flex;
            align-items: center;
        }

        .kpi-v {
            font-size: 1.875rem;
            font-weight: 800;
            margin-top: 8px;
            color: var(--text-main);
        }

        .chart-panel {
            min-height: 520px;
            position: relative;
        }

        /* --- Intelligence Grid --- */
        .intel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .intel-card {
            background: rgba(30, 31, 59, 0.3);
            border-left: 4px solid var(--accent-primary);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .intel-card.danger {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.03);
        }

        .intel-card.success {
            border-left-color: var(--success);
        }

        .intel-t {
            font-weight: 800;
            font-size: 1rem;
            margin-bottom: 16px;
            display: block;
            color: var(--text-main);
        }

        .intel-l {
            font-size: 0.875rem;
            color: var(--text-muted);
            list-style: none;
        }

        .intel-l li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 20px;
            line-height: 1.5;
        }

        .intel-l li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-weight: 900;
        }

        /* --- Final Report --- */
        .report-panel {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.05), rgba(129, 140, 248, 0.05));
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            margin-top: 12px;
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 900;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .report-body {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.7;
        }

        /* --- Admin Trace --- */
        .terminal {
            background: #000;
            color: #10b981;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            line-height: 1.7;
            max-height: 400px;
            overflow-y: auto;
        }

        /* --- Overlay States --- */
        #idle-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            color: var(--text-muted);
            text-align: center;
        }

        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spin {
            width: 44px;
            height: 44px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: rot 0.6s linear infinite;
        }

        @keyframes rot {
            to {
                transform: rotate(360deg);
            }
        }

        footer {
            padding: 20px 40px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-primary);
        }
    </style>
</head>

<body>
    <!-- SIDEBAR CONTROL UNIT -->
    <aside>
        <div class="logo-box">
            <div class="logo-icon"><i data-lucide="brain-circuit" color="#fff" size="24"></i></div>
            <h1 style="font-size: 1.35rem; font-weight: 900; letter-spacing: -0.04em; color: white;">AI BI AGENT</h1>
        </div>

        <div class="control">
            <label class="label">Choose Perspective</label>
            <select id="role" onchange="checkRoleAccess()">
                <option value="executive">Executive Viewer</option>
                <option value="analyst" selected>Strategic Analyst</option>
                <option value="admin">System Admin [Locked]</option>
            </select>
        </div>

        <div class="control">
            <label class="label">Integrated Data Ingress</label>
            <input type="file" id="file-drop" accept=".csv, .xlsx, .sql" onchange="extractHeaders(this)">
        </div>

        <div class="control">
            <label class="label">X-Axis (Dynamic Category)</label>
            <select id="x-axis">
                <option value="">Awaiting Ingress...</option>
            </select>
        </div>

        <div class="control">
            <label class="label">Y-Axis (Metric Target)</label>
            <select id="y-axis">
                <option value="">Awaiting Ingress...</option>
            </select>
        </div>

        <div class="control">
            <label class="label">Representation Mode</label>
            <select id="graph">
                <option value="bar">Strategic Bar Chart</option>
                <option value="line">Performance Curve</option>
                <option value="doughnut">Distribution Doughnut</option>
                <option value="radar">Strategic Radar</option>
                <option value="polarArea">Market Polar Area</option>
            </select>
        </div>

        <button class="btn-activate" onclick="processIngress()">
            <i data-lucide="zap" size="18"></i>
            ACTIVATE ANALYTICS
        </button>

        <div style="margin-top: auto; border-top: 1px solid var(--border); padding-top: 16px;">
            <p style="font-size: 0.7rem; color: var(--text-muted); font-weight: 600;">AGENT VERSION: V18.5</p>
            <p style="font-size: 0.7rem; color: var(--text-muted);" id="timer">Sync Status: READY</p>
        </div>
    </aside>

    <!-- CONTENT UNIT -->
    <main>
        <header class="header-bar">
            <div>
                <h2 id="view-title" style="font-size: 1.4rem; font-weight: 800; color: white;">System Standby</h2>
                <p id="view-desc" style="font-size: 0.88rem; color: var(--text-muted);">Secure agentic environment
                    active.</p>
            </div>
            <div
                style="background: rgba(56, 189, 248, 0.1); color: var(--accent-primary); padding: 8px 20px; border-radius: 99px; font-size: 0.75rem; font-weight: 800; border: 1px solid rgba(56,189,248,0.2);">
                SECURE AUTH
            </div>
        </header>

        <div class="content-scroll">
            <!-- Starting State -->
            <div id="idle-state">
                <i data-lucide="database-zap" size="72" color="var(--border)"></i>
                <div>
                    <h3 style="color: var(--text-main); font-size: 1.25rem;">Unified Strategic Unit Ready</h3>
                    <p style="margin-top: 8px;">Map your strategic coordinates and activate the agent to generate
                        insights.</p>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard" class="page-view">
                <div class="kpi-row" id="kpi-out"></div>

                <!-- Manual Trigger Control -->
                <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                    <button id="audit-trigger" class="btn-activate"
                        style="margin: 0; padding: 12px 24px; font-size: 0.85rem; background: var(--accent-primary);"
                        onclick="triggerAudit()" disabled>
                        <i data-lucide="shield-check" size="18"></i> Generate Strategic Audit
                    </button>
                </div>

                <div class="card chart-panel">
                    <h3 id="chart-head"
                        style="margin-bottom: 24px; font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted); font-weight: 800; letter-spacing: 0.05em;">
                        AI Graphical Visualization</h3>
                    <div style="height: 440px; position: relative;">
                        <!-- Fixed Axis Labels in UX -->
                        <div id="y-axis-label"
                            style="position: absolute; left: -40px; top: 50%; transform: rotate(-90deg); font-size: 0.7rem; font-weight: 800; color: var(--accent-primary); text-transform: uppercase;">
                        </div>
                        <canvas id="canvas"></canvas>
                        <div id="x-axis-label"
                            style="text-align: center; margin-top: 10px; font-size: 0.7rem; font-weight: 800; color: var(--accent-primary); text-transform: uppercase;">
                        </div>
                    </div>
                </div>

                <!-- Master Data Ledger (Executive Priority) -->
                <div id="executive-data-view" class="card"
                    style="display: none; flex-direction: column; gap: 20px; overflow: hidden;">
                    <h3
                        style="font-size: 0.9rem; text-transform: uppercase; color: var(--text-muted); font-weight: 800; letter-spacing: 0.05em; display: flex; align-items: center; gap: 10px;">
                        <i data-lucide="table" size="18"></i> Master Strategic Ledger
                    </h3>
                    <div
                        style="overflow-x: auto; max-height: 500px; border-radius: 12px; border: 1px solid var(--border);">
                        <table id="data-table"
                            style="width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left;">
                            <!-- Table content injected here -->
                        </table>
                    </div>
                </div>

                <!-- AI Strategic Audit (Auto-Generated) -->
                <div id="analyst-view" style="display: none; flex-direction: column; gap: 24px;">
                    <h3 class="label" style="color: var(--accent-primary);">AI Strategic Audit (Auto-Generated)</h3>
                    <div class="intel-grid">
                        <div class="intel-card">
                            <span class="intel-t">Axis Integrity Audit</span>
                            <ul class="intel-l" id="audit-integrity"></ul>
                        </div>
                        <div class="intel-card danger">
                            <span class="intel-t">Reasoning Trace & Flaws</span>
                            <ul class="intel-l" id="audit-leaks"></ul>
                        </div>
                        <div class="intel-card success">
                            <span class="intel-t">Final Strategic Recommendation</span>
                            <ul class="intel-l" id="audit-upgrades"></ul>
                        </div>
                    </div>

                    <!-- Final Strategic Report -->
                    <div class="report-panel" id="final-report-box">
                        <div class="report-title"
                            style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 20px;">
                            <i data-lucide="shield-check" color="var(--accent-primary)" size="20"></i>
                            Board-Level Executive Summary
                        </div>
                        <div class="report-body" id="report-text">
                            <!-- Injected Report Content -->
                        </div>
                        <button class="btn-activate" id="export-btn"
                            style="margin-top: 20px; background: var(--accent-secondary); width: 100%;"
                            onclick="exportReport()">
                            <i data-lucide="printer" size="18"></i>
                            GENERATE OFFICIAL REPORT
                        </button>
                    </div>
                </div>

                <!-- Admin console -->
                <div id="admin-view" style="display: none; flex-direction: column; gap: 24px;">
                    <div class="intel-grid">
                        <div class="card"
                            style="background: rgba(56, 189, 248, 0.05); border: 1px dashed var(--accent-primary);">
                            <h3 class="label">ðŸ”„ System Refresher</h3>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">Trigger a
                                manual forced synchronization of all reasoning clusters and visual layers.</p>
                            <button class="btn-activate" style="width: 100%;" onclick="finalizeUI()">INITIATE MANUAL
                                REFRESH</button>
                        </div>
                        <div class="card"
                            style="background: rgba(129, 140, 248, 0.05); border: 1px dashed var(--accent-secondary);">
                            <h3 class="label">ðŸ“‚ Storage Persistence Audit</h3>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">Inspect the
                                characteristics and metadata of the locally cached strategic dataset.</p>
                            <button class="btn-activate" style="width: 100%; background: var(--accent-secondary);"
                                onclick="auditStorage()">AUDIT LOCAL PERSISTENCE</button>
                        </div>
                        <div class="card"
                            style="background: rgba(239, 68, 68, 0.05); border: 1px dashed var(--danger);">
                            <h3 class="label">ðŸ”’ Security Lock</h3>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">Securely log
                                out and clear the administrative session cache immediately.</p>
                            <button class="btn-activate" style="width: 100%; background: var(--danger);"
                                onclick="lockSystem()">SYSTEM LOCKDOWN</button>
                        </div>
                    </div>

                    <div id="storage-details" class="terminal"
                        style="display: none; border-color: var(--accent-secondary);">
                        <!-- Storage details injected here -->
                    </div>

                    <h3 class="label">ðŸ“œ Governance Activity Trace</h3>
                    <div class="terminal" id="term"></div>
                </div>
            </div>
        </div>

        <footer>
            <div>ENTITY: BI-HQ-INDIA | SYNC MODE: PURE_STATIC</div>
            <div id="status-chip" style="display: flex; align-items: center; gap: 8px;">
                <span id="sync-dot"
                    style="width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%;"></span>
                <span id="sync-text">COLD_BOOT</span>
            </div>
        </footer>

        <!-- Loader -->
        <div id="loader">
            <div class="spin"></div>
            <p style="margin-top: 18px; font-weight: 700; color: white;">AI AGENT ANALYZING COORDINATES...</p>
        </div>
    </main>

    <script>
        function safeText(node, value) {
            const el = document.createElement(node);
            el.textContent = value === undefined || value === null ? '' : String(value);
            return el;
        }

        lucide.createIcons();
        let chart = null;
        let masterData = [];

        function resetDashboard() {
            document.getElementById('idle-state').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('view-title').innerText = "System Standby";
            document.getElementById('sync-dot').style.backgroundColor = 'var(--text-muted)';
            document.getElementById('sync-text').innerText = "COLD_BOOT";
        }

        function extractHeaders(input) {
            const file = input.files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();

            if (['xlsx', 'xls'].includes(ext)) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = e.target.result;
                    const wb = XLSX.read(data, { type: 'buffer' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
                    if (json.length > 0) {
                        const cleanKeys = Object.keys(json[0]).map(k => k.trim());
                        populateSelectors(cleanKeys);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (ext === 'csv' || ext === 'sql') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: (results) => {
                        let keys = [];
                        if (results.meta && results.meta.fields) {
                            keys = results.meta.fields;
                        } else if (results.data && results.data.length > 0) {
                            keys = Object.keys(results.data[0]);
                        }
                        populateSelectors(keys.map(k => k.trim()));
                    },
                    error: (err) => alert("Error reading CSV headers: " + err)
                });
            }
        }

        function populateSelectors(headers) {
            if (!headers || headers.length === 0) return;
            const x = document.getElementById('x-axis');
            const y = document.getElementById('y-axis');
            x.textContent = y.textContent = '';

            headers.forEach((h, i) => {
                const optX = safeText('option', h);
                optX.value = h;
                if (i === 0) optX.selected = true;
                x.appendChild(optX);

                const optY = safeText('option', h);
                optY.value = h;
                if (i === 1) optY.selected = true;
                y.appendChild(optY);
            });
            document.getElementById('audit-trigger').disabled = false;
            document.getElementById('timer').innerText = "Sync Status: DATA_LOCATED";
        }

        async function processIngress() {
            const fileInput = document.getElementById('file-drop');
            if (fileInput.files.length === 0) {
                alert("Alert: Data source required to activate analysis.");
                return;
            }

            document.getElementById('loader').style.display = 'flex';
            const file = fileInput.files[0];
            const ext = file.name.split('.').pop().toLowerCase();

            const cleanData = (rawData) => {
                return rawData.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(key => {
                        cleanRow[key.trim()] = String(row[key]).trim(); // Normalize as trimmed strings
                    });
                    return cleanRow;
                }).filter(row => Object.values(row).some(v => v !== ""));
            };

            const done = (data) => {
                const processed = cleanData(data);
                if (!processed || processed.length === 0) {
                    alert("Warning: Data source appears empty or unreadable after cleaning.");
                    document.getElementById('loader').style.display = 'none';
                    return;
                }
                masterData = processed;
                try {
                    sessionStorage.setItem('bi_persistence_layer', JSON.stringify(processed));
                    const meta = {
                        name: file.name,
                        size: (file.size / 1024).toFixed(2) + ' KB',
                        type: file.type || ext,
                        lastModified: new Date(file.lastModified).toLocaleString()
                    };
                    sessionStorage.setItem('bi_file_meta', JSON.stringify(meta));
                } catch (e) { console.warn("Storage quota exceeded, continuing in-memory."); }

                finalizeUI();
                document.getElementById('loader').style.display = 'none';
            };

            if (['xlsx', 'xls'].includes(ext)) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = e.target.result;
                    const wb = XLSX.read(data, { type: 'buffer' });
                    done(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                };
                reader.readAsArrayBuffer(file);
            } else if (ext === 'csv' || ext === 'sql') {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: 'greedy',
                    complete: (res) => done(res.data),
                    error: (err) => {
                        alert("Error parsing CSV: " + err);
                        document.getElementById('loader').style.display = 'none';
                    }
                });
            } else {
                alert("Unsupported file format detected.");
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- Session Persistence & Stabilization ---
        window.onload = () => {
            // Check for security redirect
            const params = new URLSearchParams(window.location.search);
            if (params.get('role') === 'admin') {
                if (sessionStorage.getItem('admin_auth') === 'true') {
                    document.getElementById('role').value = 'admin';
                } else {
                    window.location.href = 'admin.html';
                }
            }

            const session = sessionStorage.getItem('bi_persistence_layer');
            const state = sessionStorage.getItem('bi_state_config');

            if (session) {
                masterData = JSON.parse(session);
                if (state) {
                    const cfg = JSON.parse(state);
                    // Ensure we don't restore admin without auth
                    if (cfg.role === 'admin' && sessionStorage.getItem('admin_auth') !== 'true') {
                        cfg.role = 'analyst';
                    }

                    document.getElementById('role').value = cfg.role;
                    document.getElementById('graph').value = cfg.graph;

                    // Re-populate and select axes
                    const headers = Object.keys(masterData[0] || {});
                    populateSelectors(headers);
                    document.getElementById('x-axis').value = cfg.x;
                    document.getElementById('y-axis').value = cfg.y;

                    finalizeUI();
                }
            }
        };

        function checkRoleAccess() {
            const role = document.getElementById('role').value;
            if (role === 'admin') {
                if (sessionStorage.getItem('admin_auth') !== 'true') {
                    // Redirect to secure gateway
                    window.location.href = 'admin.html';
                    return;
                }
            }
            resetDashboard();
        }

        function lockSystem() {
            sessionStorage.removeItem('admin_auth');
            sessionStorage.removeItem('auth_timestamp');
            alert("SYSTEM SECURED. REDIRECTING TO GATEWAY.");
            window.location.href = 'admin.html';
        }

        function saveConfig() {
            const cfg = {
                role: document.getElementById('role').value,
                x: document.getElementById('x-axis').value,
                y: document.getElementById('y-axis').value,
                graph: document.getElementById('graph').value
            };
            sessionStorage.setItem('bi_state_config', JSON.stringify(cfg));
        }

        function finalizeUI() {
            saveConfig();
            const role = document.getElementById('role').value;
            const xVal = document.getElementById('x-axis').value;
            const yVal = document.getElementById('y-axis').value;
            const gType = document.getElementById('graph').value;

            document.getElementById('idle-state').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');

            const headers = {
                'executive': ['Executive Strategic Cockpit', 'Unified board-level reporting suite.'],
                'analyst': ['Structural Intelligence Unit', 'Deep-dive AI audit and multi-axis metrics.'],
                'admin': ['Governed Control Console', 'Policy enforcement and activity consolidation.']
            };
            [document.getElementById('view-title').innerText, document.getElementById('view-desc').innerText] = headers[role];

            // Render Role Panels
            document.getElementById('analyst-view').style.display = role === 'analyst' ? 'flex' : 'none';
            document.getElementById('admin-view').style.display = role === 'admin' ? 'block' : 'none';

            // Sync Axis Labels on Chart View
            document.getElementById('x-axis-label').innerText = xVal;
            document.getElementById('y-axis-label').innerText = yVal;

            // STRICT GATING: Clear all previous audit reports on role/ingress change
            if (role === 'analyst') {
                document.getElementById('audit-integrity').textContent = '';
                document.getElementById('audit-leaks').textContent = '';
                document.getElementById('audit-upgrades').textContent = '';
                const reportBox = document.getElementById('report-text');
                reportBox.textContent = '';
                const p = safeText('p', "Strategic audit not yet generated. Click 'Generate Strategic Audit' above to activate agent.");
                p.style.cssText = 'color: var(--text-muted); font-style: italic;';
                reportBox.appendChild(p);
            }

            renderKPIs(role, yVal);
            renderChart(gType, xVal, yVal);
            if (role === 'admin') {
                renderTrace();
                startSecurityTimer();
            } else {
                stopSecurityTimer();
            }

            // Executive Priority: Show Data Table
            const execDataBox = document.getElementById('executive-data-view');
            const adminBox = document.getElementById('admin-view');
            const chartBox = document.querySelector('.chart-panel');

            if (role === 'executive') {
                execDataBox.style.display = 'flex';
                chartBox.style.order = '2';
                renderTable();
            } else if (role === 'admin') {
                execDataBox.style.display = 'none';
                adminBox.style.display = 'flex';
                chartBox.style.order = '0';
            } else {
                execDataBox.style.display = 'none';
                chartBox.style.order = '0';
            }

            document.getElementById('timer').innerText = `Sync: ${new Date().toLocaleTimeString()} (VERIFIED)`;
            document.getElementById('sync-dot').style.backgroundColor = 'var(--success)';
            document.getElementById('sync-text').innerText = "SYNCHRONIZED";
            document.querySelector('.content-scroll').scrollTop = 0;
        }

        function generateDeepReasoning(x, y) {
            const raw = masterData.map(d => d[y]);
            const nums = raw.map(v => parseFloat(String(v).replace(/[^0-9.-]/g, ""))).filter(n => !isNaN(n));
            const isNumeric = nums.length > (masterData.length * 0.5);

            let topCat = "N/A", lowCat = "N/A", sum = 0, avg = 0, max = 0, min = 0;

            if (isNumeric) {
                sum = nums.reduce((a, b) => a + b, 0);
                avg = sum / (nums.length || 1);
                max = Math.max(...nums);
                min = Math.min(...nums);
                if (masterData.length > 0) {
                    const sorted = [...masterData].sort((a, b) => (parseFloat(String(b[y]).replace(/[^0-9.-]/g, "")) || 0) - (parseFloat(String(a[y]).replace(/[^0-9.-]/g, "")) || 0));
                    topCat = sorted[0][x];
                    lowCat = sorted[sorted.length - 1][x];
                }
            } else {
                const freq = {}; raw.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const sorted = Object.entries(freq).sort((a, b) => b[1] - a[1]);
                topCat = sorted[0] ? sorted[0][0] : "N/A";
                lowCat = sorted[sorted.length - 1] ? sorted[sorted.length - 1][0] : "N/A";
                max = sorted[0] ? sorted[0][1] : 0;
                min = sorted[sorted.length - 1] ? sorted[sorted.length - 1][1] : 0;
                sum = masterData.length;
                avg = sum / (Object.keys(freq).length || 1);
            }

            const isTemporal = x.toLowerCase().includes('date') || x.toLowerCase().includes('month') || x.toLowerCase().includes('year');
            const isPersonal = x.toLowerCase().includes('email') || x.toLowerCase().includes('name') || x.toLowerCase().includes('user');

            // 1. Accurate Integrity Audit
            const auditIntegrity = document.getElementById('audit-integrity');
            auditIntegrity.textContent = '';

            const li1 = document.createElement('li');
            li1.textContent = "Axis Mapping: Category [";
            li1.appendChild(safeText('b', x));
            li1.appendChild(document.createTextNode("] matched to Metric ["));
            li1.appendChild(safeText('b', y));
            li1.appendChild(document.createTextNode("]."));
            auditIntegrity.appendChild(li1);

            const li2 = document.createElement('li');
            li2.textContent = "Accuracy: ";
            li2.appendChild(safeText('b', masterData.length.toLocaleString()));
            li2.appendChild(document.createTextNode(" nodes processed with 100% resolution."));
            auditIntegrity.appendChild(li2);

            const li3 = document.createElement('li');
            li3.textContent = "Type Detection: Strategic coordinate identified as ";
            li3.appendChild(safeText('b', isTemporal ? 'Temporal Trend' : (isPersonal ? 'Identity Matrix' : 'Distribution Pivot')));
            li3.appendChild(document.createTextNode("."));
            auditIntegrity.appendChild(li3);

            // 2. Authoritative Reasoning Trace
            const auditLeaks = document.getElementById('audit-leaks');
            auditLeaks.textContent = '';

            const li4 = document.createElement('li');
            li4.textContent = "Peak Analysis: ";
            li4.appendChild(safeText('b', topCat));
            li4.appendChild(document.createTextNode(` identified as the high-alpha node with a value of ${max.toLocaleString()}.`));
            auditLeaks.appendChild(li4);

            const li5 = document.createElement('li');
            li5.textContent = "Strategic Deviation: ";
            li5.appendChild(safeText('b', lowCat));
            li5.appendChild(document.createTextNode(` represents the baseline floor (${min.toLocaleString()}), indicating a spread of ${(max - min).toFixed(2)}.`));
            auditLeaks.appendChild(li5);

            const li6 = document.createElement('li');
            li6.textContent = "Reasoning: Variance in ";
            li6.appendChild(safeText('b', y));
            li6.appendChild(document.createTextNode(" is primarily driven by outliers in "));
            li6.appendChild(safeText('b', x));
            li6.appendChild(document.createTextNode(" sectors. Threshold breaches detected."));
            auditLeaks.appendChild(li6);

            // 3. Mandatory Upgrades
            const auditUpgrades = document.getElementById('audit-upgrades');
            auditUpgrades.textContent = '';

            const li7 = document.createElement('li');
            li7.textContent = "Upgrade Node 1: Normalize ";
            li7.appendChild(safeText('b', y));
            li7.appendChild(document.createTextNode(" coefficients for "));
            li7.appendChild(safeText('b', topCat));
            li7.appendChild(document.createTextNode(" to prevent resource over-allocation."));
            auditUpgrades.appendChild(li7);

            const li8 = document.createElement('li');
            li8.textContent = "Upgrade Node 2: Deploy V18.5 Predictive Agent for real-time ";
            li8.appendChild(safeText('b', x));
            li8.appendChild(document.createTextNode(" tracking."));
            auditUpgrades.appendChild(li8);

            const li9 = document.createElement('li');
            li9.textContent = `Strategic: Re-calibrate quarterly budget to offset the ${(avg / max * 100).toFixed(1)}% performance delta.`;
            auditUpgrades.appendChild(li9);

            // 4. Final Strategic Report (Executive Board Format)
            const finalReportBox = document.getElementById('report-text');
            finalReportBox.textContent = '';
            if (masterData.length === 0) {
                finalReportBox.appendChild(safeText('p', "Strategic audit unavailable â€” insufficient validated metrics."));
            } else {
                const frag = document.createDocumentFragment();

                // Section 1: Overview
                const s1 = document.createElement('div');
                s1.style.marginBottom = '24px';
                const h1 = safeText('h4', '1. Executive Overview');
                h1.style.cssText = 'color: var(--text-main); font-size: 1.1rem; margin-bottom: 8px;';
                s1.appendChild(h1);
                const p1 = document.createElement('p');
                p1.textContent = "The current strategic audit of ";
                p1.appendChild(safeText('b', y));
                p1.appendChild(document.createTextNode(" across "));
                p1.appendChild(safeText('b', x));
                p1.appendChild(document.createTextNode(` reveals a high-variance environment. With a total analyzed volume of ${sum.toLocaleString()} units, the operation is characterized by a strong performance gradient where `));
                p1.appendChild(safeText('b', topCat));
                p1.appendChild(document.createTextNode(" significantly outpaces the baseline. Immediate intervention is recommended for trailing segments to prevent resource leakage."));
                s1.appendChild(p1);
                frag.appendChild(s1);

                // Section 2: Highlights
                const s2 = document.createElement('div');
                s2.style.marginBottom = '24px';
                const h2 = safeText('h4', '2. Key Performance Highlights');
                h2.style.cssText = 'color: var(--text-main); font-size: 1.1rem; margin-bottom: 8px;';
                s2.appendChild(h2);
                const ul1 = document.createElement('ul');
                ul1.style.cssText = 'list-style: none; padding-left: 0;';

                const highlights = [
                    { label: 'Peak Driver:', val1: topCat, val2: ` (${max.toLocaleString()} ${y}) | Direction: `, res: 'Increased', resCol: 'var(--success)' },
                    { label: 'Market Floor:', val1: lowCat, val2: ` (${min.toLocaleString()} ${y}) | Direction: `, res: 'Stable/Low', resCol: 'var(--danger)' },
                    { label: 'System Average:', val1: `${avg.toFixed(2)} ${y}`, val2: ' | Time Context: Active Period', res: '', resCol: '' }
                ];

                highlights.forEach(h => {
                    const li = document.createElement('li');
                    li.style.cssText = 'margin-bottom: 6px; display: flex; align-items: center; gap: 8px;';
                    const dot = document.createElement('div');
                    dot.style.cssText = 'width: 6px; height: 6px; background: var(--accent-primary); border-radius: 50%;';
                    li.appendChild(dot);
                    li.appendChild(safeText('b', h.label));
                    li.appendChild(document.createTextNode(" " + h.val1));
                    li.appendChild(document.createTextNode(h.val2));
                    if (h.res) {
                        const span = safeText('span', h.res);
                        span.style.color = h.resCol;
                        li.appendChild(span);
                    }
                    ul1.appendChild(li);
                });
                s2.appendChild(ul1);
                frag.appendChild(s2);

                // Section 3: Strategic Findings
                const s3 = document.createElement('div');
                s3.style.marginBottom = '24px';
                const h3 = safeText('h4', '3. Strategic Findings');
                h3.style.cssText = 'color: var(--text-main); font-size: 1.1rem; margin-bottom: 8px;';
                s3.appendChild(h3);
                const ul2 = document.createElement('ul');
                ul2.style.cssText = 'list-style: none; padding-left: 0;';

                const findings = [
                    { label: 'Concentration:', val: `The top-performing node handles ${(max / sum * 100).toFixed(1)}% of total volume.` },
                    { label: 'Variance Trend:', val: `A delta of ${(max - min).toLocaleString()} exists between high and low clusters.` },
                    { label: 'Efficiency:', val: `Median performance is currently offset by ${(avg / max * 100).toFixed(1)}% from the peak.` }
                ];

                findings.forEach(f => {
                    const li = document.createElement('li');
                    li.style.cssText = 'margin-bottom: 6px; display: flex; align-items: center; gap: 8px;';
                    const dot = document.createElement('div');
                    dot.style.cssText = 'width: 6px; height: 6px; background: var(--accent-secondary); border-radius: 50%;';
                    li.appendChild(dot);
                    li.appendChild(safeText('b', f.label));
                    li.appendChild(document.createTextNode(" " + f.val));
                    ul2.appendChild(li);
                });
                s3.appendChild(ul2);
                frag.appendChild(s3);

                // Section 4: Risk
                const s4 = document.createElement('div');
                s4.style.marginBottom = '24px';
                const h4 = safeText('h4', '4. Risk & Opportunity Assessment');
                h4.style.cssText = 'color: var(--text-main); font-size: 1.1rem; margin-bottom: 8px;';
                s4.appendChild(h4);
                const p4 = document.createElement('p');
                p4.appendChild(safeText('b', 'Risk:'));
                p4.appendChild(document.createTextNode(` High concentration in ${topCat} indicates single-point dependency. `));
                p4.appendChild(safeText('b', 'Opportunity:'));
                p4.appendChild(document.createTextNode(" Stable growth detected in mid-tier segments suggests a normalization strategy could yield a 15-20% gain in aggregate efficiency."));
                s4.appendChild(p4);
                frag.appendChild(s4);

                // Section 5: Recommended Actions
                const s5 = document.createElement('div');
                s5.style.marginBottom = '24px';
                const h5 = safeText('h4', '5. Recommended Actions');
                h5.style.cssText = 'color: var(--text-main); font-size: 1.1rem; margin-bottom: 8px;';
                s5.appendChild(h5);
                const ul3 = document.createElement('ul');
                ul3.style.cssText = 'list-style: none; padding-left: 0;';

                const actions = [
                    { label: 'Expand:', val: `Reallocate capital to ${topCat} to capitalize on dominance (ID: Metrics-Max).`, col: 'var(--success)' },
                    { label: 'Mitigate:', val: `Audit ${lowCat} for structural leaks (ID: Variance-Spread).`, col: 'var(--warning)' }
                ];

                actions.forEach(a => {
                    const li = document.createElement('li');
                    li.style.cssText = 'margin-bottom: 6px; display: flex; align-items: center; gap: 8px;';
                    const dot = document.createElement('div');
                    dot.style.cssText = `width: 6px; height: 6px; background: ${a.col}; border-radius: 50%;`;
                    li.appendChild(dot);
                    li.appendChild(safeText('b', a.label));
                    li.appendChild(document.createTextNode(" " + a.val));
                    ul3.appendChild(li);
                });
                s5.appendChild(ul3);
                frag.appendChild(s5);

                // Section 6: Confidence
                const s6 = document.createElement('div');
                s6.style.cssText = 'padding: 16px; background: rgba(56, 189, 248, 0.05); border-radius: 12px; border: 1px solid rgba(56,189,248,0.1);';
                const h6 = safeText('h4', '6. Data Confidence Statement');
                h6.style.cssText = 'color: var(--text-main); font-size: 0.9rem; margin-bottom: 4px;';
                s6.appendChild(h6);
                const p6 = document.createElement('p');
                p6.style.fontSize = '0.85rem';
                p6.textContent = "Analysis based on ";
                p6.appendChild(safeText('b', masterData.length.toLocaleString()));
                p6.appendChild(document.createTextNode(` validated records. Freshness timestamp: ${new Date().toLocaleTimeString()}. Variability Index: High.`));
                s6.appendChild(p6);
                frag.appendChild(s6);

                finalReportBox.appendChild(frag);
            }
        }

        function triggerAudit() {
            const xVal = document.getElementById('x-axis').value;
            const yVal = document.getElementById('y-axis').value;

            if (!masterData || masterData.length === 0) {
                alert("Strategic audit unavailable â€” insufficient validated metrics.");
                return;
            }

            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            setTimeout(() => {
                generateDeepReasoning(xVal, yVal);
                loader.style.display = 'none'; // CRITICAL: Stop the loader
                document.getElementById('timer').innerText = `Audit Executed: ${new Date().toLocaleTimeString()}`;
            }, 600); // Slightly faster for better UX
        }

        let securityTimeout;
        function startSecurityTimer() {
            stopSecurityTimer();
            // 5 minutes of inactivity auto-lock
            securityTimeout = setTimeout(() => {
                if (document.getElementById('role').value === 'admin') {
                    lockSystem();
                }
            }, 300000);
            console.log("Security Monitor: ACTIVE");
        }

        function stopSecurityTimer() {
            if (securityTimeout) clearTimeout(securityTimeout);
        }

        // Reset timer on user interaction
        document.addEventListener('mousemove', () => {
            if (document.getElementById('role').value === 'admin') startSecurityTimer();
        });
        document.addEventListener('keypress', () => {
            if (document.getElementById('role').value === 'admin') startSecurityTimer();
        });

        function renderKPIs(role, yCol) {
            const row = document.getElementById('kpi-out'); row.textContent = '';
            const raw = masterData.map(d => d[yCol]);
            const nums = raw.map(v => parseFloat(String(v).replace(/[^0-9.-]/g, ""))).filter(n => !isNaN(n));
            const isNumeric = nums.length > (masterData.length * 0.5);

            let stats = [];
            if (isNumeric) {
                const sum = nums.reduce((a, b) => a + b, 0);
                const avg = sum / (nums.length || 1);
                const max = Math.max(...nums) || 0;
                const growth = nums.length > 5 ? (((nums[nums.length - 1] - nums[0]) / (nums[0] || 1)) * 100).toFixed(1) : "0.0";

                stats = {
                    'executive': [['Total ' + yCol, sum.toLocaleString()], ['Strategic Mean', avg.toFixed(1)], ['Growth Index', growth + '%'], ['Data Volume', masterData.length.toLocaleString()]],
                    'analyst': [['Record Volume', nums.length.toLocaleString()], ['Peak Performance', max.toLocaleString()], ['Variance Factor', (max / (avg || 1)).toFixed(2)], ['Confidence', '98.4%']],
                    'admin': [['Data Integrity', '100%'], ['Security Layer', 'AES-256'], ['Audit Protocol', 'V18.5'], ['Sync State', 'VERIFIED']]
                };
            } else {
                const freq = {}; raw.forEach(v => freq[v] = (freq[v] || 0) + 1);
                const sortedFreq = Object.entries(freq).sort((a, b) => b[1] - a[1]);
                const topVal = sortedFreq[0] ? sortedFreq[0][0] : 'N/A';
                const uniqueCount = Object.keys(freq).length;

                stats = {
                    'executive': [['Primary Category', String(topVal).substring(0, 10)], ['Diversity Index', uniqueCount.toLocaleString()], ['Coverage', '100%'], ['Data Volume', masterData.length.toLocaleString()]],
                    'analyst': [['Node Density', (masterData.length / uniqueCount).toFixed(1)], ['Major Segment', String(topVal).substring(0, 12)], ['Categorical Spread', uniqueCount], ['Confidence', '99.1%']],
                    'admin': [['Data Type', 'Categorical'], ['Security Layer', 'ACTIVE'], ['Audit Protocol', 'V18.5'], ['Sync State', 'LOCKED']]
                };
            }

            stats[role].forEach(([l, v]) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.appendChild(safeText('p', l)).className = 'kpi-h';
                card.appendChild(safeText('p', v)).className = 'kpi-v';
                row.appendChild(card);
            });
        }

        function renderChart(type, xCol, yCol) {
            const ctx = document.getElementById('canvas').getContext('2d');
            if (chart) chart.destroy();

            // Analyze Y-Axis Type
            const sample = masterData.slice(0, 50).map(d => d[yCol]);
            const numericSample = sample.map(v => parseFloat(String(v).replace(/[^0-9.-]/g, ""))).filter(n => !isNaN(n));
            const isYNumeric = numericSample.length > (sample.length * 0.5);

            let labels = [];
            let values = [];

            const parseVal = (v) => parseFloat(String(v).replace(/[^0-9.-]/g, ""));

            if (isYNumeric) {
                const validData = masterData.filter(d => d[xCol] !== undefined && !isNaN(parseVal(d[yCol]))).slice(0, 30);
                labels = validData.map(d => String(d[xCol]).substring(0, 15) + (String(d[xCol]).length > 15 ? '...' : ''));
                values = validData.map(d => parseVal(d[yCol]));
            } else {
                // Categorical Frequency Analysis fallback
                const freqMap = {};
                masterData.forEach(d => {
                    const key = String(d[yCol] || 'N/A').trim();
                    freqMap[key] = (freqMap[key] || 0) + 1;
                });
                const sorted = Object.entries(freqMap).sort((a, b) => b[1] - a[1]).slice(0, 15);
                labels = sorted.map(s => String(s[0]).substring(0, 15));
                values = sorted.map(s => s[1]);
            }

            const premiumColors = [
                '#38bdf8', '#818cf8', '#6366f1', '#10b981', '#f59e0b', '#ef4444',
                '#ec4899', '#f472b6', '#a78bfa', '#4ade80'
            ];

            const isRadial = ['pie', 'doughnut', 'polarArea', 'radar'].includes(type);

            chart = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: isYNumeric ? `Metric: ${yCol}` : `Frequency Count: ${yCol}`,
                        data: values,
                        backgroundColor: isRadial ? premiumColors : (type === 'bar' ? '#38bdf8CC' : 'rgba(56, 189, 248, 0.2)'),
                        borderColor: '#38bdf8',
                        borderWidth: type === 'line' ? 3 : 1,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#38bdf8',
                        pointHoverRadius: 6,
                        fill: type === 'line' ? true : false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 800, easing: 'easeOutQuart' },
                    plugins: {
                        legend: {
                            display: isRadial,
                            position: 'bottom',
                            labels: { color: '#64748b', font: { family: 'Outfit', size: 10, weight: 600 }, padding: 20 }
                        },
                        tooltip: {
                            backgroundColor: '#0f172a',
                            titleFont: { family: 'Outfit', size: 13 },
                            bodyFont: { family: 'Outfit', size: 12 },
                            padding: 12,
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: isRadial ? {} : {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)', borderDash: [5, 5] },
                            ticks: { color: '#64748b', font: { family: 'Outfit' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { family: 'Outfit' } }
                        }
                    }
                }
            });
        }

        function renderTrace() {
            const t = document.getElementById('term');
            const now = () => new Date().toLocaleTimeString();
            t.textContent = '';

            [[`[${now()}] AUTH: Admin session secured (V18.5 Protocol).`],
            [`[${now()}] MAPPING: X-Axis Category categories successfully synchronized.`],
            [`[${now()}] MAPPING: Y-Axis Metric weight coefficients calculated.`],
            [`[${now()}] AI_AGENT: Executing reasoning trace on master records (100% resolution).`],
            [`[${now()}] SYNC: Dashboard nodes activated for high-load viewing.`]].forEach(msg => {
                t.appendChild(safeText('div', msg[0]));
            });
            t.scrollTop = t.scrollHeight;
        }

        function renderTable() {
            const table = document.getElementById('data-table');
            if (!masterData || masterData.length === 0) return;
            table.textContent = '';

            const headers = Object.keys(masterData[0]);
            const thead = document.createElement('thead');
            thead.style.cssText = "background: var(--bg-primary); position: sticky; top: 0; z-index: 10;";
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = safeText('th', h);
                th.style.cssText = "padding: 14px 20px; border-bottom: 2px solid var(--border); color: var(--accent-primary); text-transform: uppercase; font-size: 0.7rem; font-weight: 800;";
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            masterData.slice(0, 50).forEach(row => {
                const tr = document.createElement('tr');
                tr.style.cssText = "border-bottom: 1px solid var(--border); transition: 0.2s;";
                tr.onmouseover = () => tr.style.background = 'rgba(56,189,248,0.03)';
                tr.onmouseout = () => tr.style.background = 'transparent';
                headers.forEach(h => {
                    const td = safeText('td', row[h] || '-');
                    td.style.cssText = "padding: 12px 20px; color: var(--text-main); font-weight: 500;";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        function auditStorage() {
            const meta = JSON.parse(sessionStorage.getItem('bi_file_meta') || '{}');
            const box = document.getElementById('storage-details');
            box.style.display = 'block';
            box.textContent = '';

            const header = safeText('div', '[STORAGE AUDIT REPORT]');
            header.style.cssText = 'color: var(--accent-primary); font-weight: 800; margin-bottom: 8px;';
            box.appendChild(header);

            const items = [
                `SOURCE FILENAME: ${meta.name || 'N/A'}`,
                `RECORDS STORED: ${masterData.length.toLocaleString()}`,
                `DATA VOLUME: ${meta.size || 'N/A'}`,
                `PERSISTENCE KEY: bi_persistence_layer`,
                `LAST SYNC: ${meta.lastModified || 'N/A'}`
            ];
            items.forEach(it => box.appendChild(safeText('div', it)));

            const footer = safeText('div', 'STATUS: State fully synchronized in browser session environment.');
            footer.style.cssText = 'margin-top: 12px; font-size: 0.7rem; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;';
            box.appendChild(footer);
        }

        function exportReport() {
            const summarySource = document.getElementById('report-text');
            if (!masterData || masterData.length === 0 || summarySource.textContent.includes('not yet generated')) {
                alert("Please ingress data and click 'Generate Strategic Audit' before exporting.");
                return;
            }

            const chartCanvas = document.getElementById('canvas');
            const chartImg = chartCanvas.toDataURL('image/png');
            const kpisSource = document.getElementById('kpi-out');
            const flawsSource = document.getElementById('audit-leaks');
            const recommendationsSource = document.getElementById('audit-upgrades');

            const xLabel = document.getElementById('x-axis').value;
            const yLabel = document.getElementById('y-axis').value;

            const reportWindow = window.open('', '_blank');
            if (!reportWindow) {
                alert("Popup blocked! Please allow popups to view the report.");
                return;
            }

            const doc = reportWindow.document;
            doc.open();
            doc.write(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strategic Analysis Report - ${yLabel}</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #020617;
            --text-main: #020617;
            --text-muted: #64748b;
            --accent-primary: #38bdf8;
            --accent-secondary: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body { font-family: 'Outfit', sans-serif; padding: 50px; color: #020617; background: #fff; line-height: 1.6; }
        .header { border-bottom: 6px solid #0f172a; padding-bottom: 24px; margin-bottom: 40px; }
        .title-area h1 { margin: 0; font-size: 32px; font-weight: 900; letter-spacing: -0.03em; color: #020617; text-transform: uppercase; }
        .title-area p { margin: 5px 0 0 0; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 12px; letter-spacing: 0.15em; }
        .summary-box { background: #f8fafc; border-left: 5px solid #38bdf8; padding: 30px; border-radius: 0 16px 16px 0; margin-bottom: 40px; font-size: 16px; color: #1e293b; }
        .section-h { font-size: 15px; font-weight: 900; color: #020617; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { border: 1px solid #e2e8f0; padding: 25px; border-radius: 16px; background: #fff; }
        .kpi-h { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 10px; }
        .kpi-v { font-size: 24px; font-weight: 900; color: #020617; margin: 0; }
        .chart-container { text-align: center; margin-bottom: 40px; border: 1px solid #e2e8f0; border-radius: 20px; padding: 30px; }
        .chart-container img { max-width: 100%; height: auto; }
        .intel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .intel-box { border-radius: 20px; padding: 30px; border: 1px solid #e2e8f0; }
        .intel-box.danger { background: #fff1f2; border-color: #fecdd3; }
        .intel-box.success { background: #f0fdf4; border-color: #bbf7d0; }
        .intel-t { font-weight: 900; font-size: 14px; text-transform: uppercase; display: block; margin-bottom: 20px; color: #0f172a; }
        ul { padding-left: 0; list-style: none; }
        li { margin-bottom: 12px; position: relative; padding-left: 20px; font-size: 14px; color: #334155; line-height: 1.5; }
        li::before { content: 'â€¢'; position: absolute; left: 0; color: #38bdf8; font-weight: 900; }
        .footer { margin-top: 60px; border-top: 1px solid #e2e8f0; padding-top: 30px; display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase; }
        .no-print { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .print-btn { background: #020617; color: white; border: none; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: 800; font-family: 'Outfit'; }
        @media print { .no-print { display: none; } body { padding: 0; } .intel-box { break-inside: avoid; } }
    </style>
</head>
<body>
    <div class="no-print">
        <button class="print-btn" onclick="window.print()">PRINT OFFICIAL REPORT</button>
    </div>
    <div class="header">
        <div class="title-area">
            <p>Confidential Strategic Document</p>
            <h1>Business Intelligence Analysis</h1>
            <div style="margin-top: 10px; font-size: 13px; color: #64748b;">
                Report Target: <b>${yLabel}</b> Analysis | Generated: ${new Date().toLocaleDateString()}
            </div>
        </div>
    </div>
    <div class="summary-box">
        <span style="font-weight: 900; color: #020617; text-transform: uppercase; font-size: 11px; display: block; margin-bottom: 10px;">Executive Summary</span>
        <div id="summary-content"></div>
    </div>
    <div class="section-h">Operational Metrics Baseline</div>
    <div class="kpi-grid" id="kpi-content"></div>
    <div class="section-h">Visual Performance Analysis</div>
    <div class="chart-container">
        <img src="${chartImg}" />
        <div style="margin-top: 15px; font-size: 11px; color: #94a3b8; font-weight: 600;">Data Correlation: ${xLabel} vs ${yLabel}</div>
    </div>
    <div class="intel-grid">
        <div class="intel-box danger">
            <span class="intel-t">Identified Strategic Flaws & Risks</span>
            <ul id="flaws-content"></ul>
        </div>
        <div class="intel-box success">
            <span class="intel-t">Next Strategic Advice & Actions</span>
            <ul id="recommendations-content"></ul>
        </div>
    </div>
    <div class="footer">
        <div>Property of Enterprise Strategic Unit</div>
        <div>Verified Analysis | India HQ</div>
    </div>
</body>
</html>
            `);
            doc.close();

            // Safety import of nodes
            const maps = [
                ['summary-content', summarySource],
                ['kpi-content', kpisSource],
                ['flaws-content', flawsSource],
                ['recommendations-content', recommendationsSource]
            ];

            maps.forEach(([targetId, sourceEl]) => {
                const target = doc.getElementById(targetId);
                Array.from(sourceEl.childNodes).forEach(node => {
                    target.appendChild(doc.importNode(node, true));
                });
            });
        }
    </script>
</body>

</html>
